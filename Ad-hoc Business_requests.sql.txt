SELECT
  dim_city.city_name,
    COUNT(fact_trips.trip_id) AS total_trips,
    CASE
        WHEN SUM(fact_trips.distance_travelled_km) > 0 THEN 
            ROUND(SUM(fact_trips.fare_amount) / SUM(fact_trips.distance_travelled_km), 2)
        ELSE 
            NULL
  END AS avg_fare_per_km,
    CASE
        WHEN COUNT(fact_trips.trip_id) > 0 THEN 
            ROUND(SUM(fact_trips.fare_amount) / COUNT(fact_trips.trip_id),2)
        ELSE 
            NULL
  END AS avg_fare_per_trip,
    CASE
        WHEN COUNT(fact_trips.trip_id) > 0 THEN 
            ROUND(COUNT(fact_trips.trip_id) * 100 / (SELECT COUNT(fact_trips.trip_id) FROM trips_db.fact_trips), 2)
        ELSE 
            NULL
  END AS percentage_contribution_to_total_trips
    
FROM
  trips_db.fact_trips
    LEFT JOIN 
  trips_db.dim_city ON dim_city.city_id = fact_trips.city_id
GROUP BY
  dim_city.city_name
ORDER BY
  total_trips DESC;
  
WITH trips AS (
    SELECT
        dim_city.city_id AS city_id,
        SUM(CASE WHEN rtd.trip_count = "2-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS two,
        SUM(CASE WHEN rtd.trip_count = "3-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS three,
        SUM(CASE WHEN rtd.trip_count = "4-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS four,
        SUM(CASE WHEN rtd.trip_count = "5-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS five,
        SUM(CASE WHEN rtd.trip_count = "6-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS six,
        SUM(CASE WHEN rtd.trip_count = "7-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS seven,
        SUM(CASE WHEN rtd.trip_count = "8-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS eight,
        SUM(CASE WHEN rtd.trip_count = "9-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS nine,
        SUM(CASE WHEN rtd.trip_count = "10-Trips" THEN rtd.repeat_passenger_count ELSE 0 END) AS ten
    FROM
        trips_db.dim_city
    LEFT JOIN
        trips_db.dim_repeat_trip_distribution AS rtd ON dim_city.city_id = rtd.city_id
    GROUP BY
        dim_city.city_id
),

total_trips AS (
  SELECT
    trips.city_id AS city_id,
    (trips.two + trips.three + trips.four + trips.five + trips.six + trips.seven + trips.eight + trips.nine + trips.ten) AS total
  FROM
    trips
)
        
SELECT
  dim_city.city_name,
    ROUND((trips.two * 100 /total_trips.total), 2) AS "2-Trips",
    ROUND((trips.three * 100 /total_trips.total), 2) AS "3-Trips",
    ROUND((trips.four * 100 /total_trips.total), 2) AS "4-Trips",
    ROUND((trips.five * 100 /total_trips.total), 2) AS "5-Trips",
    ROUND((trips.six * 100 /total_trips.total), 2) AS "6-Trips",
    ROUND((trips.seven * 100 /total_trips.total), 2) AS "7-Trips",
    ROUND((trips.eight * 100 /total_trips.total), 2) AS "8-Trips",
    ROUND((trips.nine * 100 /total_trips.total), 2) AS "9-Trips",
    ROUND((trips.ten * 100 /total_trips.total), 2) AS "10-Trips"
    
FROM 
  trips_db.dim_city
    JOIN
    trips ON dim_city.city_id = trips.city_id
    JOIN
    total_trips ON dim_city.city_id = total_trips.city_id
    
ORDER BY dim_city.city_name;

WITH rank_cte AS
  (SELECT
    dim_city.city_id,
    SUM(fps.new_passengers) AS new_passengers,
    RANK() OVER (ORDER BY SUM(fps.new_passengers) DESC) AS _rank

  FROM
    trips_db.dim_city
    LEFT JOIN
    trips_db.fact_passenger_summary AS fps ON dim_city.city_id = fps.city_id

  GROUP BY dim_city.city_id)

SELECT
  dim_city.city_name AS city_name,
    rank_cte.new_passengers AS total_new_passengers,
    CASE
    WHEN rank_cte._rank < 4 THEN "Top 3"
        WHEN rank_cte._rank > 7 THEN "Bottom 3"
        ELSE " "
  END AS city_category
           
FROM
  trips_db.dim_city
    JOIN
    rank_cte ON dim_city.city_id = rank_cte.city_id
ORDER BY total_new_passengers DESC;

WITH rank_cte AS
  (SELECT
    dim_city.city_id,
    SUM(fps.new_passengers) AS new_passengers,
    RANK() OVER (ORDER BY SUM(fps.new_passengers) DESC) AS _rank

  FROM
    trips_db.dim_city
    LEFT JOIN
    trips_db.fact_passenger_summary AS fps ON dim_city.city_id = fps.city_id

  GROUP BY dim_city.city_id)

SELECT
  dim_city.city_name AS city_name,
    rank_cte.new_passengers AS total_new_passengers,
    CASE
    WHEN rank_cte._rank < 4 THEN "Top 3"
        WHEN rank_cte._rank > 7 THEN "Bottom 3"
        ELSE " "
  END AS city_category
           
FROM
  trips_db.dim_city
    JOIN
    rank_cte ON dim_city.city_id = rank_cte.city_id
ORDER BY total_new_passengers DESC;

WITH date_cte AS (
    SELECT DISTINCT
        start_of_month,
        month_name
    FROM trips_db.dim_date
),

city_cte AS (
    SELECT
        dim_city.city_id AS city_id,
        CASE
            WHEN SUM(fact_passenger_summary.total_passengers) > 0 THEN 
                ROUND((SUM(fact_passenger_summary.repeat_passengers) * 100/ SUM(fact_passenger_summary.total_passengers)), 2)
            ELSE 
                NULL
        END AS city_RPR
    FROM
        trips_db.dim_city
        LEFT JOIN
        trips_db.fact_passenger_summary ON dim_city.city_id = fact_passenger_summary.city_id
    GROUP BY city_id
),

detailed_data AS (
    SELECT
        dim_city.city_name AS city_name,
        date_cte.month_name AS month,
        fact_passenger_summary.total_passengers AS total_passengers,
        fact_passenger_summary.repeat_passengers AS repeat_passengers,
        CASE
            WHEN fact_passenger_summary.total_passengers > 0 THEN 
                ROUND((fact_passenger_summary.repeat_passengers * 100/ fact_passenger_summary.total_passengers), 2)
            ELSE 
                NULL
        END AS monthly_repeat_passenger_rate,
        0 AS city_repeat_passenger_rate,
    date_cte.start_of_month AS start_of_month
    FROM
        trips_db.dim_city
        LEFT JOIN
        trips_db.fact_passenger_summary ON dim_city.city_id = fact_passenger_summary.city_id
        LEFT JOIN
        date_cte ON date_cte.start_of_month = fact_passenger_summary.month
  GROUP BY dim_city.city_name, date_cte.month_name, fact_passenger_summary.city_id, fact_passenger_summary.month
    
),

summary_data AS (
    SELECT
        dim_city.city_name AS city_name,
        'Total' AS month,
        SUM(fact_passenger_summary.total_passengers) AS total_passengers,
        SUM(fact_passenger_summary.repeat_passengers) AS repeat_passengers,
        0 AS monthly_repeat_passenger_rate,
        city_cte.city_RPR AS city_repeat_passenger_rate,
    MIN(date_cte.start_of_month) AS start_of_month
    FROM
        trips_db.dim_city
        LEFT JOIN
        trips_db.fact_passenger_summary ON dim_city.city_id = fact_passenger_summary.city_id
        JOIN
        city_cte ON dim_city.city_id = city_cte.city_id
        LEFT JOIN
        date_cte ON date_cte.start_of_month = fact_passenger_summary.month
        
  GROUP BY dim_city.city_name, city_cte.city_id
    
)

SELECT *
FROM (
    SELECT
    city_name,
    month,
    total_passengers,
    repeat_passengers,
    monthly_repeat_passenger_rate,
    city_repeat_passenger_rate
    FROM
    detailed_data
    UNION ALL
    SELECT
    city_name,
        month,
        total_passengers,
        repeat_passengers,
        monthly_repeat_passenger_rate,
        city_repeat_passenger_rate
  FROM
    summary_data
    ) AS combined_data
ORDER BY
    city_name,
    CASE
    WHEN month = 'Total' THEN 1 ELSE 0 END
;
